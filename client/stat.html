<!DOCTYPE html>
<html>
<head>
<title>Chat</title>
<script type='text/javascript' src='http://humanisti.fixme.fi:8888/nowjs/now.js' ></script>
<script type='text/javascript' src='js/jquery.js'></script>
<script type='text/javascript' src='js/jquery-ui.js'></script>
<script type='text/javascript' src='js/underscore.js'></script>
<script type='text/javascript' src='js/d3.js'></script>
<script type='text/javascript' src='js/date.js'></script>
<link rel='stylesheet' type='text/css' href='css/ui-lightness/jquery-ui-1.8.18.custom.css' />
<link rel='stylesheet' type='text/css' href='app.css' />
</head>
<body>

<style>
.chart div {
 font: 10px sans-serif;
 background-color: steelblue;
 text-align: right;
 padding: 3px;
 margin: 1px;
 color: white;
}
</style>

<div id='wrapper'>

<table id='users'>
<tr>
<td>User</td>
<td>Opening</td>
<td>Openings avr</td>
<td>Response</td>
<td>Response avr</td>
<td>Total</td>
<td>Avr</td>
</tr>
</table>

</div>

<script>
// store all comments per user here
var comments = {};

// count all data here
var data = {};

$(document).ready( function(){

now.receiveMessage = function(msg){
    var nick = msg.from.nick;
    if( ! _.has( comments , nick ) ) {
          comments[nick] = [];

	  // store all data once
          data[nick] = {};
          var k = data[nick];
          k.id = msg.from.variant;
          // extend propoerties
          k.opening = 0;
          k.openingLength = 0;
          k.response = 0;
          k.responseLength = 0;
    }
    comments[nick].push( msg );

    count(msg);
    show();
}

} );

function count(msg) {
    var k = data[msg.from.nick];
    if( msg.depth == 0 ) {
        k.opening++;
        k.openingLength += msg.content.length;
    } else {
        k.response++;
        k.responseLenght += msg.content.length;
    }
}

function show() {
  $('.data').remove();
  $.each( data , function(a,b) {
     var t = $('<tr>', { class : 'data' } );
     t.append( $('<td>').html( a + ' ' + b.id ) );
     t.append( $('<td>').html( b.opening ) );
     t.append( $('<td>').html( b.openingLength / b.opening ) );
     t.append( $('<td>').html( b.response ) );
     t.append( $('<td>').html( b.responseLength / b.response ) );

     var tot = b.response + b.opening;
     var totL = b.openingLength + b.responseLength;
     t.append( $('<td>').html( tot ) );
     t.append( $('<td>').html( totL / tot ) );

     $('#users').append( t );
  } );
}
</script>

</body>
</html>

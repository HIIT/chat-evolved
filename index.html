<!DOCTYPE html>
<html>
<head>
<title>Chat</title>
<script type='text/javascript' src='http://humanisti.fixme.fi:8888/nowjs/now.js' ></script>
<script type='text/javascript' src='js/jquery-1.7.1.min.js'></script>
<script type='text/javascript' src='js/jquery-ui-1.8.18.custom.min.js'></script>  
<script type='text/javascript' src='js/date.js'></script>
<link rel='stylesheet' type='text/css' href='css/ui-lightness/jquery-ui-1.8.18.custom.css' />
<link rel='stylesheet' type='text/css' href='app.css' />
</head>
<body>

<div id='wrapper'>

<input id='input' label='Chat' class="ui-widget ui-corner-all"></input>

<div id='conv-0'>

</div>

</div>

<script>
function _text( msg ) {
   var text = "";
   text += "<span class='timestamp'>" + msg.time + "</span> ";
   text += msg.from.nick + ": ";
   text += msg.content;
   return text;
}

function addLine( base, msg) {
   // rewrap to object
   msg.time = new Date( msg.time );

   // container
   var $container = $('<div>' , { class : 'message' } );
   // actual message
   var $content = $('<div>' , { id : 'conv-' + msg.id } );
  
   // only inline when there is thread
   if ( msg.depth > 0 ) $container.addClass( 'inline' );

   $content.html( _text( msg ) );
   $container.append( $content );


   var $i = null;
   // comment only if allowed
   if ( msg.allowResponse ) {
      $i = $('<input>' , { class : 'inline', label: 'Comment' } );
      $container.append( $i );
      var msg = msg;
      sendMsg( $i , msg );
   }

   // flash the content on the main stream
   if ( msg.flash ) {
       var $f = $('<div>', { html : _text( msg ) } );
       $('#conv-0').prepend( $f );
       $f.fadeOut( 4 * 1000 );
   }

   if ( msg.collabse ) {
      var $col = $('<span>' , {html: '-', class: 'collabse-toggle'} );
      // todo: cleanup!
      $col.click( function() {
         $.each( $content.children().find('div') , function(i, e) { $(e).toggle(); } );
         if( $i ) $i.toggle();
         var t = '-';
         if( $(this).html() == t ) t = '+';
         $(this).html( t );
      } );
      $content.append( $col );

      // TODO: could be cleaned!
      // check parent's state
      var p = $('#conv-' + msg.response.id ).find('.collabse-toggle').html();
      if( p == '+' ) $content.hide();
   }

   // append on top or on bottom of container
   if( msg.depth == 0 ) {
     base.prepend( $container );
   } else {
     base.append( $container );
   }
}

function sendMsg ( field, responseTo ) {
  var f = field;

  // replace with 3rd party plugin?
  f.focus( function() {
    if( f.val() == f.attr('label') ) f.val('');
  } );
  f.blur( function() {   
    if( f.val() == '' ) f.val( f.attr('label') );
  } );

  f.val( f.attr('label') );


  // detect enter
  f.keypress(function(e) {
    if(e.keyCode == 13) {
      var t = f.val();
      f.val('');
      now.distributeMessage( t , responseTo );
    }
  } );
}

$(document).ready(function(){

now.receiveMessage = function(msg){
    // experimental setup
    msg.allowResponse = msg.depth < 1;
    msg.flash = false;
    msg.collabse = false;

    var v = now.user.variant;

    // plane chat
    if( v == 0 ) {
      msg.response.id = 0;
      msg.depth = 0;
      msg.allowResponse = false;
    } else {
      if( v % 2 == 0 ) msg.flash = msg.depth > 0;
      if( v > 2 ) msg.collabse = msg.allowResponse;
    }
    addLine( $('#conv-' + msg.response.id) , msg );
}

sendMsg( $('#input') , { id : 0, depth : -1 } );

function createUser() {
   var nick = $('#nick');
   // require a nick
   if( nick.val() == '' ) {
      nick.effect('pulsate');
      return false;
   }

   now.user.nick = nick.val();
   return true;
}

// user login dialog
var login = $('<div>');
login.append( $('<input>', { id : 'nick' } ) );
login.dialog( {
  modal: true,
  title: 'Who are you?',
  buttons: [ { text: "Ok", click: function(){ $(this).dialog("close"); } } ],
  beforeClose: createUser,
} );

});
</script>

</body>
</html>
